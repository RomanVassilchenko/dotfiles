#!/usr/bin/env bash
# prepare-commit-msg hook to strip bat formatting from commit messages
# This prevents issues when cat is aliased to bat

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only process if this is a regular commit (not merge, squash, etc.)
if [ -z "$COMMIT_SOURCE" ] || [ "$COMMIT_SOURCE" = "message" ]; then
    # Check if the commit message contains bat formatting artifacts
    if grep -q "^─────" "$COMMIT_MSG_FILE" || grep -q "^ *[0-9]* │" "$COMMIT_MSG_FILE"; then
        # Create a temporary file for the cleaned message
        TEMP_FILE=$(mktemp)

        # Strip bat formatting:
        # - Remove lines starting with ───── (borders)
        # - Remove the "STDIN" and "Size:" header lines
        # - Remove line numbers and │ separators (format: "   1 │ content")
        # - Remove empty lines that only have line numbers
        sed -E '
            /^─────/d
            /^ *│ STDIN/d
            /^ *│ Size:/d
            /^ *│ File:/d
            /^ *[0-9]+ │$/d
            s/^ *[0-9]+ │ //
        ' "$COMMIT_MSG_FILE" > "$TEMP_FILE"

        # Replace original with cleaned version
        mv "$TEMP_FILE" "$COMMIT_MSG_FILE"
    fi
fi

exit 0
